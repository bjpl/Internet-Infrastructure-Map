#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for secrets and sensitive information
echo "Scanning for secrets..."
if command -v gitleaks &> /dev/null; then
  gitleaks protect --staged --verbose
  if [ $? -ne 0 ]; then
    echo "‚ùå Secret detected! Please remove sensitive data before committing."
    exit 1
  fi
else
  echo "‚ö†Ô∏è  GitLeaks not installed. Skipping secret scan."
  echo "Install with: brew install gitleaks (macOS) or download from https://github.com/gitleaks/gitleaks"
fi

# Check for common sensitive file patterns
echo "Checking for sensitive files..."
SENSITIVE_FILES=$(git diff --cached --name-only | grep -E '\.env$|\.pem$|\.key$|\.p12$|credentials|secret|password' || true)
if [ ! -z "$SENSITIVE_FILES" ]; then
  echo "‚ùå Sensitive files detected in commit:"
  echo "$SENSITIVE_FILES"
  echo "Please ensure these files are in .gitignore"
  exit 1
fi

# Check for TODO/FIXME with security context
echo "Checking for security TODOs..."
SECURITY_TODOS=$(git diff --cached | grep -i "TODO.*secur\|FIXME.*secur\|XXX.*secur" || true)
if [ ! -z "$SECURITY_TODOS" ]; then
  echo "‚ö†Ô∏è  Security-related TODOs found:"
  echo "$SECURITY_TODOS"
  echo "Please address security issues before committing or create a tracking issue."
fi

# Run linting with security focus
echo "Running security-focused linting..."
if command -v npm &> /dev/null; then
  npm run lint:security 2>/dev/null || echo "‚ö†Ô∏è  No lint:security script found in package.json"
fi

# Check for hardcoded secrets in code
echo "Scanning for hardcoded secrets..."
HARDCODED_PATTERNS="(password|passwd|pwd|secret|token|api_key|apikey|access_key|private_key)\s*=\s*['\"]"
FOUND_SECRETS=$(git diff --cached | grep -iE "$HARDCODED_PATTERNS" || true)
if [ ! -z "$FOUND_SECRETS" ]; then
  echo "‚ùå Potential hardcoded secrets found:"
  echo "$FOUND_SECRETS"
  echo "Please use environment variables or secure secret management."
  exit 1
fi

# Check file size to prevent committing large files
echo "Checking file sizes..."
MAX_FILE_SIZE=5242880 # 5MB
for file in $(git diff --cached --name-only); do
  if [ -f "$file" ]; then
    file_size=$(wc -c < "$file")
    if [ $file_size -gt $MAX_FILE_SIZE ]; then
      echo "‚ùå File $file is too large ($(($file_size / 1024 / 1024))MB). Maximum allowed: 5MB"
      echo "Large files may contain accidentally committed data or binaries."
      exit 1
    fi
  fi
done

echo "‚úÖ Pre-commit security checks passed!"
